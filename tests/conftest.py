import pytest
import pytest_asyncio
from httpx import AsyncClient, ASGITransport
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.pool import StaticPool

from app.main import app
from app.core.db import get_session
from app.core.dependencies import get_current_user
from app.models.base import Base  
from app.models.user import User
from app.models.ticker import Ticker
from app.models.portfolio import Portfolio


DATABASE_URL = "sqlite+aiosqlite:///:memory:"

engine = create_async_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False},
    poolclass=StaticPool,
)

TestingSessionLocal = async_sessionmaker(engine, expire_on_commit=False)


@pytest_asyncio.fixture(scope="function", autouse=True)
async def setup_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)


@pytest_asyncio.fixture
async def session():
    async with TestingSessionLocal() as s:
        yield s


# Override DB session
async def override_get_session():
    async with TestingSessionLocal() as s:
        yield s


# Override auth â€” returns a fake user
def make_auth_override(user: User):
    def override():
        return user
    return override


@pytest_asyncio.fixture
async def seeded_user(session: AsyncSession) -> User:
    user = User(userId=1, email="test@example.com", password="x")
    session.add(user)
    await session.commit()
    await session.refresh(user)
    return user


@pytest_asyncio.fixture
async def seeded_ticker(session: AsyncSession) -> Ticker:
    ticker = Ticker(ticker_id=1, symbol="AAPL", name="Apple Inc.")
    session.add(ticker)
    await session.commit()
    await session.refresh(ticker)
    return ticker


@pytest_asyncio.fixture
async def seeded_portfolio(session: AsyncSession, seeded_user: User) -> Portfolio:
    portfolio = Portfolio(portfolioId=1, userId=seeded_user.userId, name="My Portfolio", description="Test")
    session.add(portfolio)
    await session.commit()
    await session.refresh(portfolio)
    return portfolio


@pytest_asyncio.fixture
async def client(seeded_user: User) -> AsyncClient:
    app.dependency_overrides[get_session] = override_get_session
    app.dependency_overrides[get_current_user] = make_auth_override(seeded_user)
    async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
        yield ac
    app.dependency_overrides.clear()